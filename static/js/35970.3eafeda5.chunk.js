"use strict";(self.webpackChunkok_wpa_maps=self.webpackChunkok_wpa_maps||[]).push([[35970],{35970:(e,t,i)=>{i.r(t),i.d(t,{default:()=>S});var r=i(89379),n=i(6326),s=i(3825),o=i(50076),a=i(42553),l=i(49304),u=i(90534),d=i(46053),c=(i(81806),i(76460),i(47249),i(28379)),h=i(87990),m=i(17707),g=i(61979),f=i(54994);class p{constructor(e){this.moments=[],this.forwardMoments=[],this.moments.push(e)}push(e){return this.forwardMoments.length,this.moments.push(e)}pop(){if(!(this.forwardMoments.length>0))return this.moments.pop()}undo(){if(!this.canUndo())return;const e=this.moments.pop();return this.forwardMoments.push(e),e}peek(){return this.moments.at(-1)}canUndo(){return this.moments.length>1}canRedo(){return this.hasForwardEdits()}redo(){if(!this.canRedo())return;const e=this.forwardMoments.pop();return this.moments.push(e),e}size(){return this.moments.length+this.forwardMoments.length}hasForwardEdits(){return this.forwardMoments.length>0}clearForwardEdits(){this.forwardMoments=[]}}var v=i(35298),y=i(74691);i(62754);class w{constructor(e){this.versionableItem=e,this.type="feature-layer"}get gdbVersion(){return this.versionableItem.gdbVersion}set gdbVersion(e){this.versionableItem.gdbVersion=e}get historicMoment(){return this.versionableItem.historicMoment}set historicMoment(e){this.versionableItem.historicMoment=e}get featureServiceUrl(){return this.versionableItem.url.replace(/^(.*\/FeatureServer)\/\d+$/,"$1")}}(0,n.Cg)([(0,d.MZ)({readOnly:!0})],w.prototype,"type",void 0),(0,n.Cg)([(0,d.MZ)()],w.prototype,"gdbVersion",null),(0,n.Cg)([(0,d.MZ)({type:Date})],w.prototype,"historicMoment",null),(0,n.Cg)([(0,d.MZ)({readOnly:!0})],w.prototype,"featureServiceUrl",null);class V{constructor(e){this.versionableItem=e,this.type="network"}get gdbVersion(){return this.versionableItem.gdbVersion}set gdbVersion(e){this.versionableItem.gdbVersion=e}get historicMoment(){return this.versionableItem.historicMoment}set historicMoment(e){this.versionableItem.historicMoment=e}get featureServiceUrl(){return this.versionableItem.featureServiceUrl}}(0,n.Cg)([(0,d.MZ)({readOnly:!0})],V.prototype,"type",void 0),(0,n.Cg)([(0,d.MZ)()],V.prototype,"gdbVersion",null),(0,n.Cg)([(0,d.MZ)({type:Date})],V.prototype,"historicMoment",null),(0,n.Cg)([(0,d.MZ)({readOnly:!0})],V.prototype,"featureServiceUrl",null);class b{constructor(e){this.versionableItem=e,this.type="subtype-group-layer"}get gdbVersion(){return this.versionableItem.gdbVersion}set gdbVersion(e){this.versionableItem.gdbVersion=e}get historicMoment(){return this.versionableItem.historicMoment}set historicMoment(e){this.versionableItem.historicMoment=e}get featureServiceUrl(){return this.versionableItem.url.replace(/^(.*\/FeatureServer)\/\d+$/,"$1")}}function I(e){return"networkServiceUrl"in e?new V(e):"feature"!==e.type||(0,y.hc)(e)?"subtype-group"!==e.type||(0,y.hc)(e)?null:new b(e):new w(e)}function M(e){const t=[];for(const i of e)if("group"===i.type){const e=i,r=e.allTables.concat(e.allLayers);for(const i of r)if("feature"===i.type||"subtype-group"===i.type){const e=I(i);e&&t.push(e)}}else{const e=I(i);e&&t.push(e)}return t}(0,n.Cg)([(0,d.MZ)({readOnly:!0})],b.prototype,"type",void 0),(0,n.Cg)([(0,d.MZ)()],b.prototype,"gdbVersion",null),(0,n.Cg)([(0,d.MZ)({type:Date})],b.prototype,"historicMoment",null),(0,n.Cg)([(0,d.MZ)({readOnly:!0})],b.prototype,"featureServiceUrl",null);let C=class extends((0,a.T)(l.x_)){constructor(e){super(e),this.url=null,this.sourceJSON=null,this.name=null,this.defaultVersionIdentifier=null,this.capabilities=null,this._isDefault=e=>!e||e===this.defaultVersionIdentifier.name,this._dateEquals=(e,t)=>!e&&!t||!(!e||!t)&&e.toISOString()===t.toISOString(),this._applyEditsHandler=e=>{const{serviceUrl:t,gdbVersion:i,result:r}=e;t===this._featureServiceUrl&&r.then(e=>{const t=e.historicMoment;t&&this._addMomentToVersionItem(i,t)})}}initialize(){var e;this.url=(0,u.UC)(this.url),this._featureServiceUrl=this.url.replace(/\/VersionManagementServer/i,"/FeatureServer"),v.DC.has(this.url)||v.DC.set(this.url,new Map);const t=(null!==(e=v.CD.get(this.url))&&void 0!==e?e:0)+1;v.CD.set(this.url,t),this.when().then(()=>this.addHandles((0,g.Jz)(this._applyEditsHandler)),()=>{})}destroy(){var e;const t=(null!==(e=v.CD.get(this.url))&&void 0!==e?e:1)-1;v.CD.set(this.url,t),0===t&&v.DC.delete(this.url),v.Z3.delete(this._featureServiceUrl)}read(e,t){this.sourceJSON=e,super.read(e,t)}readDefaultVersionIdentifier(e,t){return{name:t.defaultVersionName,guid:t.defaultVersionGuid}}writeDefaultVersionIdentifier(e,t){t.defaultVersionName=e.name,t.defaultVersionGuid=e.guid}get loaded(){return super.loaded}load(e){return this.addResolvingPromise(this._fetchService(this.url,e)),Promise.resolve(this)}async createVersion(e){const[{createVersion:t},{default:r}]=await Promise.all([i.e(45075).then(i.bind(i,45075)),i.e(1015).then(i.bind(i,1015))]),n=r.from(e);return t(this.url,n)}async deleteVersion(e){var t;const[{deleteVersion:r},{default:n}]=await Promise.all([i.e(83842).then(i.bind(i,83842)),i.e(81702).then(i.bind(i,81702))]);let s;e.guid&&(null===(t=v.DC.get(this.url))||void 0===t?void 0:t.has(e.guid))&&(s=null!==v.TA&&void 0!==v.TA?v.TA:void 0);const o=new n({versionName:e.name,sessionId:s});return r(this.url,o)}async getVersionInfoExtended(e){const{getVersion:t}=await i.e(52811).then(i.bind(i,52811));return t(this.url,e.guid)}async getVersionInfos(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const[{getVersionInfos:t},{default:r}]=await Promise.all([i.e(78362).then(i.bind(i,78362)),i.e(13358).then(i.bind(i,13358))]),n=r.from(e);return t(this.url,n)}async reconcile(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const[{reconcile:r},{default:n}]=await Promise.all([i.e(35331).then(i.bind(i,35331)),i.e(16089).then(i.bind(i,16089))]),s=n.from(t);return s.sessionId=v.TA,r(this.url,e.guid,s)}async post(e){const[{post:t},{default:r}]=await Promise.all([i.e(90017).then(i.bind(i,90017)),i.e(45431).then(i.bind(i,45431))]),n=r.from({sessionId:v.TA});return t(this.url,e.guid,n)}async alterVersion(e,t){const[{alterVersion:r},{default:n}]=await Promise.all([i.e(36289).then(i.bind(i,36289)),i.e(34185).then(i.bind(i,34185))]),s=n.from(t);return r(this.url,e.guid,s)}async startReading(e){return(await this.startReadingWithResult(e)).success}async startReadingWithResult(e){const{startReading:t}=await i.e(31729).then(i.bind(i,31729)),r=await t(this.url,e.guid,v.TA);if(r.success){const t=await this.getVersionInfoExtended(e),i=new Date(t.modifiedDate),r={name:t.versionIdentifier.name,moment:i,lockType:"read"};this._addOrUpdateItem(e.guid,r),(0,g.$9)(this._featureServiceUrl,null,e.name,i)}return r}async stopReading(e){return(await this.stopReadingWithResult(e)).success}async stopReadingWithResult(e){var t;const{stopReading:r}=await i.e(10153).then(i.bind(i,10153)),n=await r(this.url,e.guid,v.TA);return n.success&&(null!==(t=v.DC.get(this.url))&&void 0!==t&&t.delete(e.guid),(0,g.$9)(this._featureServiceUrl,null,e.name,null)),n}async startEditing(e){return(await this.startEditingWithResult(e)).success}async startEditingWithResult(e){const{startEditing:t}=await i.e(75213).then(i.bind(i,75213)),r=await t(this.url,e.guid,v.TA);if(r.success){const t=await this.getVersionInfoExtended(e),i=new Date(t.modifiedDate),r=new p(i),n={name:e.name,moment:i,lockType:"edit",stack:r};this._addOrUpdateItem(e.guid,n),(0,g.$9)(this._featureServiceUrl,null,e.name,i)}return r}async stopEditing(e,t){return(await this.stopEditingWithResult(e,t)).success}async stopEditingWithResult(e,t){if(t){var r,n;const t=null===(r=v.DC.get(this.url))||void 0===r?void 0:r.get(e.guid);if(null!==t&&void 0!==t&&null!==(n=t.stack)&&void 0!==n&&n.canRedo()){const[{deleteForwardEdits:r},{default:n}]=await Promise.all([i.e(56868).then(i.bind(i,56868)),i.e(37028).then(i.bind(i,37028))]),s=await r(this.url,e.guid,new n({sessionId:v.TA,moment:t.moment}));if(!s.success)return s}}const{stopEditing:s}=await i.e(15093).then(i.bind(i,15093)),o=await s(this.url,e.guid,v.TA,t);if(o.success){const t=await this.getVersionInfoExtended(e),i=new Date(t.modifiedDate);this._addOrUpdateItem(e.guid,{name:e.name,moment:i,lockType:"read",editMomentStack:void 0}),(0,g.$9)(this._featureServiceUrl,null,e.name,i)}return o}getLockType(e){var t;const i=null===(t=v.DC.get(this.url))||void 0===t||null===(t=t.get(e.guid))||void 0===t?void 0:t.lockType;return null!==i&&void 0!==i?i:"none"}async changeVersion(e,t,i){if(i&&"name"in i&&!await this.getVersionInfoExtended(i))throw new o.A("version-management-service:invalid-version","version does not exist");if("networkServiceUrl"in e){if(this._featureServiceUrl.toLowerCase()===e.featureServiceUrl.toLowerCase())return this._changeVersionInternal(e,t,i)}else{let r;"layers"in e?(r=e.allTables.concat(e.allLayers),e.utilityNetworks&&e.utilityNetworks.forEach(e=>{this._featureServiceUrl.toLowerCase()===e.featureServiceUrl.toLowerCase()&&this._changeVersionInternal(e,t,i)})):r=e;for(const e of r)if("feature"===e.type||"subtype-group"===e.type){const r=/^(.*\/FeatureServer)\/\d+$/,n=e.url.replace(r,"$1");if(this._featureServiceUrl.toLowerCase()===n.toLowerCase()&&!this._changeVersionInternal(e,t,i))return!1}else if("group"===e.type){const r=e.allTables.concat(e.allLayers);for(const e of r)if("feature"===e.type||"subtype-group"===e.type){const r=/^(.*\/FeatureServer)\/\d+$/,n=e.url.replace(r,"$1");if(this._featureServiceUrl.toLowerCase()===n.toLowerCase()&&!this._changeVersionInternal(e,t,i))return!1}}}return!0}async changeVersionWithResult(e,t,i){let r;if("layers"in e){const t=M(e.allTables.concat(e.allLayers).filter(e=>"group"!==e.type).toArray());e.utilityNetworks&&e.utilityNetworks.forEach(e=>{const i=M([e]);t.push(...i)}),r=t}else r=e;if(i&&"name"in i&&!await this.getVersionInfoExtended(i)){const e=new Map;for(const t of r)e.set(t,{success:!1});return e}if(t&&"name"in t&&"none"!==this.getLockType(t)){const e=new Map;for(const t of r)e.set(t,{success:!1});return e}const n=new Map;for(const s of r)if(s)if(s.featureServiceUrl.toLowerCase()===this._featureServiceUrl.toLowerCase()){const e=this._changeVersionInternalWithResult(s,t,i);n.set(s,e)}else n.set(s,{success:!1});return n}async getVersionIdentifierFromName(e){try{var t;return(null===(t=(await this.getVersionInfos({includeHidden:!0})).find(t=>t.versionIdentifier.name.toUpperCase()===e.toUpperCase()))||void 0===t?void 0:t.versionIdentifier)||null}catch(i){return null}}async getVersionIdentifierFromGuid(e){const{getVersion:t}=await i.e(52811).then(i.bind(i,52811));try{return(await t(this.url,e)).versionIdentifier}catch(r){return null}}canUndo(e){var t,i;const r=null===(t=v.DC.get(this.url))||void 0===t?void 0:t.get(e.guid);return!(null===r||void 0===r||null===(i=r.stack)||void 0===i||!i.canUndo())}canRedo(e){var t,i;const r=null===(t=v.DC.get(this.url))||void 0===t?void 0:t.get(e.guid);return!(null===r||void 0===r||null===(i=r.stack)||void 0===i||!i.canRedo())}undo(e){var t,i;const n=null===(t=v.DC.get(this.url))||void 0===t?void 0:t.get(e.guid),s=(null===n||void 0===n||null===(i=n.stack)||void 0===i?void 0:i.undo())||void 0;if(n&&s){var o;const t=n.stack.peek();(0,g.$9)(this._featureServiceUrl,null,e.name,t),null===(o=v.DC.get(this.url))||void 0===o||o.set(e.guid,(0,r.A)((0,r.A)({},n),{},{moment:t}))}}redo(e){var t,i,n;const s=null===(t=v.DC.get(this.url))||void 0===t?void 0:t.get(e.guid),o=(null===s||void 0===s||null===(i=s.stack)||void 0===i?void 0:i.redo())||void 0;s&&o&&((0,g.$9)(this._featureServiceUrl,null,e.name,o),null===(n=v.DC.get(this.url))||void 0===n||n.set(e.guid,(0,r.A)((0,r.A)({},s),{},{moment:o})))}_setUpData(e,t){let i=null,r=null,n=null,s=null;const a=e=>{var t,i;const r=null===v.DC||void 0===v.DC||null===(t=v.DC.get(this.url))||void 0===t?void 0:t.get(e.guid);n=e.name,s=null!==(i=null===r||void 0===r?void 0:r.moment)&&void 0!==i?i:null};if(e&&"name"in e){if("none"!==this.getLockType(e))throw new o.A("version-management-service:version-locked","version is locked");i=e.name,r=null,t&&"name"in t?a(t):(n=this.defaultVersionIdentifier.name,s=t)}else i=this.defaultVersionIdentifier.name,r=e,t&&"name"in t?a(t):(n=this.defaultVersionIdentifier.name,s=t);return{fromVersionName:i,fromMoment:r,toVersionName:n,toMoment:s}}_changeVersionInternal(e,t,i){try{const{fromVersionName:r,fromMoment:n,toVersionName:s,toMoment:o}=this._setUpData(t,i);(this._isDefault(r)&&this._isDefault(e.gdbVersion)&&this._dateEquals(e.historicMoment,n)||r===e.gdbVersion&&this._dateEquals(e.historicMoment,n))&&(e.gdbVersion=s,e.historicMoment=o)}catch(r){return!1}return!0}_changeVersionInternalWithResult(e,t,i){try{const{fromVersionName:r,fromMoment:n,toVersionName:s,toMoment:o}=this._setUpData(t,i);return this._isDefault(r)&&this._isDefault(e.gdbVersion)&&this._dateEquals(e.historicMoment,n)||r===e.gdbVersion&&this._dateEquals(e.historicMoment,n)?(e.gdbVersion=s,e.historicMoment=o,{success:!0}):{success:!1}}catch(r){return{success:!1}}}_addMomentToVersionItem(e,t){const i=v.DC.get(this.url);if(i)for(const[r,n]of i)n.name===e&&this._addToStack(r,t)}_addToStack(e,t){const i=v.DC.get(this.url),n=null===i||void 0===i?void 0:i.get(e);return!(null===n||void 0===n||!n.stack)&&(function(e,t){if(e)return e.getTime()<t.getTime();return!0}(n.stack.peek(),t)&&n.stack.push(t),i.set(e,(0,r.A)((0,r.A)({},n),{},{moment:t})),!0)}_addOrUpdateItem(e,t){const i=v.DC.get(this.url),n=null===i||void 0===i?void 0:i.get(e);return n?(i.set(e,(0,r.A)((0,r.A)({},n),t)),!0):!(!t.name||!t.lockType)&&(null!==i&&void 0!==i&&i.set(e,(0,r.A)((0,r.A)({},t),{},{lockType:t.lockType})),!0)}async _fetchService(e,t){if(this.sourceJSON){this.read(this.sourceJSON,{origin:"service",url:(0,f.Dl)(e)});const t=new u.s0(this.url).host;return void v.Z3.set(t,this.defaultVersionIdentifier.name)}const i=await(0,s.A)(e,(0,r.A)({responseType:"json",query:{f:"json"}},t));this.read(i.data)}};(0,n.Cg)([(0,d.MZ)()],C.prototype,"url",void 0),(0,n.Cg)([(0,d.MZ)()],C.prototype,"sourceJSON",void 0),(0,n.Cg)([(0,d.MZ)({type:String,json:{write:!0}})],C.prototype,"name",void 0),(0,n.Cg)([(0,d.MZ)({json:{write:{target:{defaultVersionName:{type:String},defaultVersionGuid:{type:String}}},read:{source:["defaultVersionName","defaultVersionGuid"]}}})],C.prototype,"defaultVersionIdentifier",void 0),(0,n.Cg)([(0,c.w)("defaultVersionIdentifier",["defaultVersionName","defaultVersionGuid"])],C.prototype,"readDefaultVersionIdentifier",null),(0,n.Cg)([(0,m.K)("defaultVersionIdentifier",{defaultVersionName:{type:String},defaultVersionGuid:{type:String}})],C.prototype,"writeDefaultVersionIdentifier",null),(0,n.Cg)([(0,d.MZ)({json:{write:!0}})],C.prototype,"capabilities",void 0),C=(0,n.Cg)([(0,h.$)("esri.versionManagement.VersionManagementService")],C);const S=C}}]);
//# sourceMappingURL=35970.3eafeda5.chunk.js.map